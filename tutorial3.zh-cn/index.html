
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
        <head>
                <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> 
                <title>web.py 0.3 新手指南 (web.py)</title>
                <link rel="stylesheet" type="text/css" href="/static/webpy-new.css"/>
                <link rel="SHORTCUT ICON" href="/static/favicon.ico"/>
        </head>
<body>

        <div id="header">
                <span class="logo"><a href="/" title="Home"><img src="/static/webpy.gif" alt="" /></a></span>
                <span class="blurb">&quot;Think about the ideal way to write a web app.<br />Write the code to make it happen.&quot; <a href="http://groups.google.com/group/webpy/msg/f266701d97e7ceb1">(More...)</a></span>
        </div>

        <div id="location">
                <a href="/">home</a> &gt; web.py 0.3 新手指南
        </div>

<div id="container">
        <div id="sidebar">
                  <strong>Get It:</strong><br />
                  &nbsp;<a href="/download">download</a><br />
                  &nbsp;<a href="/changes">change log</a><br />
                  <br />
                  
                  <strong>Learn It:</strong><br />
                  &nbsp;<a href="/install">install</a><br />
                  &nbsp;<a href="/tutorial3.en">tutorial</a><br />

                  &nbsp;<a href="/faq">faq</a><br />
                  &nbsp;<a href="/docs/0.3">docs</a><br />
                  &nbsp;<a href="/recommended_setup">setup</a><br />
          &nbsp;<a href="/cookbook">cookbook</a><br/>
                  <br />
                  
                  <strong>Discuss It:</strong><br />
                  &nbsp;<a href="http://groups.google.com/group/webpy/">mailing list</a><br />
                  &nbsp;<a href="irc://irc.freenode.net/webpy">irc</a><br />
                  <br />
        
                  <strong>Follow It:</strong><br />
                  &nbsp;<a href="http://github.com/webpy/webpy">code</a><br />
          &nbsp;<a href="http://launchpad.net/webpy">launchpad</a><br />
</div>

<div id="main">
<div id="content">


<h1>web.py 0.3 新手指南</h1>

<h2>开始</h2>
<p>你知道Python同时你希望制作一个网站。 那么web.py正好提供了一种简单的方法。
</p>
<p>如果你希望读完整个指南， 你需要安装Python, web.py, flup, psycopg2, 和Postgres (或者等价的数据库和Python驱动)。 详细，可以查看 <a href="http://webpy.org/">webpy.org</a>.
</p>
<p>如果你已经有了一个web.py项目，请看看<a href="/docs/0.3/upgrade">升级</a> 页面的相关信息。
</p>
<p>准备开始。
</p>

<h2>URL 处理</h2>
<p>任何网站最重要的部分就是它的URL结构。你的URL并不仅仅只是访问者所能看到并且能发给朋友的。它还规定了你网站运行的心智模型。在一些类似<a href="http://del.icio.us/">del.icio.us</a>的流行网站 , URL甚至是UI的一部分。 web.py使这类强大的URL成为可能。
</p>
<p>在开始你的web.py程序之前,打开一个文本文件（文件名为code.py）输入:
</p>
<pre><code>import web
</code></pre><p>这条语句会导入web.py模块。
</p>
<p>现在我们需要把我们的URL结构告诉web.py。让我从下面这个简单的例子开始:
</p>
<pre><code>urls = (
  '/', 'index'
)
</code></pre><p>第一部分是匹配URL的<a href="http://osteele.com/tools/rework/">正则表达式</a>，像<code>/</code>、<code>/help/faq</code>、<code>/item/(\d+)</code>等(<code>\d+</code>将匹配数字)。圆括号表示捕捉对应的数据以便后面使用。第二部分是接受请求的类名称，像<code>index</code>、<code>view</code>、<code>welcomes.hello</code> (<code>welcomes</code>模块的<code>hello</code>类)，或者<code>get_\1</code>。<code>\1</code> 会被正则表达式捕捉到的内容替换，剩下来捕捉的的内容将被传递到你的函数中去。
</p>
<p>这行表示我们要URL<code>/</code>(首页)被一个叫<code>index</code>的类处理。
</p>
<p>现在我们需要创建一个列举这些url的application。
</p>
<pre><code>app = web.application(urls, globals())
</code></pre><p>这会告诉web.py去创建一个基于我们刚提交的URL列表的application。这个application会在这个文件的全局命名空间中查找对应类。
</p>

<h2>GET和POST: 区别</h2>
<p>现在我们需要来写<code>index</code>类。虽然大多数人只会看看，并不会注意你的浏览器在使用用于与万维网通信的HTTP语言。具体的细节并不重要，但是要理解web访问者请求web服务器去根据URL(像<code>/</code>、<code>/foo?f=1</code>)执行一个合适的函数（像<code>GET</code>、<code>POST</code>）的基本思想。
</p>
<p><code>GET</code>是我们都熟悉的。它用于请求网页文本。当你在浏览器输入<code>harvard.edu</code>，它会直接访问Harvard的web服务器，去<code>GET /</code>。 第二个最有名的是<code>POST</code>，它经常被用在提交form，比如请求买什么东西。每当提交一个去做什么事情(像使用信用卡处理一笔交易)的请求时，你可以使用<code>POST</code>。这是关键，因为<code>GET</code>的URL可以被搜索引擎索引，并通过搜索引擎访问。虽然大部分页面你希望被索引，但是少数类似订单处理的页面你是不希望被索引的 (想象一下Google尝试去购买你网站上的所有东西)。
</p>
<p>在我们web.py的代码中，我们将这两个方法明确区分:
</p>
<pre><code>class index:
    def GET(self):
        return &quot;Hello, world!&quot;
</code></pre><p>当有人用<code>GET</code>请求<code>/</code>时，这个<code>GET</code>函数随时会被web.py调用。
</p>
<p>好了，限制我们只需要最后一句就写完了。这行会告诉web.py开始提供web页面:
</p>
<pre><code>if __name__ == &quot;__main__&quot;: app.run()
</code></pre><p>这会告诉web.py为我们启动上面我们写的应用。
</p>
<p>现在注意，即使我已经在这里说了很多，但我们真正有5行这些代码。这就是你需要编写的一个完整的web.py应用。如果你在命令行下面，请输入:
</p>
<pre><code>$ python code.py
http://0.0.0.0:8080/
</code></pre><p>现在你的web.py应用正运行在你电脑上的一个真正的web服务器上。 访问那个URL，然后你应该看到&quot;Hello, world!&quot; (你可以通过把IP地址/端口加在&quot;code.py&quot;的后面，来控制web.py在哪里启动服务器。你也可以让它运行在<code>fastcgi</code>或<code>scgi</code>服务器上)。
</p>
<p><strong>注意:</strong> 如果你不能或者不想使用默认端口，你可以使用这样的命令来指定端口号:
</p>
<pre><code>$ python code.py 1234
</code></pre>
<h2>模板</h2>
<p>在 Python 中写 HTML 不是聪明的选择，相反在 HTML 中写 Python 则有趣的多。幸运的是，<code>web.py</code> 让这件事情做得简单而又漂亮。
</p>
<p><strong>注意：</strong> 老版本的 <code>web.py</code> 使用 <a href="http://www.cheetahtemplate.org/">Cheetah 模板系统</a>，你可以也欢迎使用其他模板系统，但它可能不会被长久支持。
</p>
<p>给模板新建一个目录（命名为 <code>templates</code>），在该目录下新建一个以 <code>.html</code> 结尾的文件，内容如下：
</p>
<pre><code>&lt;em&gt;Hello&lt;/em&gt;, world!
</code></pre><p>你也可以在模板中使用 <code>web.py</code> 模板支持代码：
</p>
<pre><code>$def with (name)

$if name:
    I just wanted to say &lt;em&gt;hello&lt;/em&gt; to $name.
$else:
    &lt;em&gt;Hello&lt;/em&gt;, world!
</code></pre><p>如上，该模板看起来就像 python 文件一样，除了顶部的 <code>def with</code> (表示从模板将从这后面取值)和总是位于代码段之前的<code>$</code>。当前，<code>template.py</code> 首先请求模板文件的首行 <code>$def</code> 。当然，你要注意 <code>web.py</code> 将会转义任何任何用到的变量，所以当你将 <code>name</code> 的值设为是一段 HTML 时，它会被转义显示成纯文本。如果要关闭该选项，可以写成 <code>$:name</code> 来代替 <code>$name</code>。
</p>
<p>回看再看 <code>code.py</code>。在第一行之下添加：
</p>
<pre><code>render = web.template.render('templates/')
</code></pre><p>这会告诉web.py到你的模板目录中去查找模板。然后把 <code>index.GET</code>改成:
   告诉 <code>web.py</code> 在你的模板目录下查找模板文件。修改 <code>index.GET</code> ：
</p>
<pre><code>name = 'Bob'    
return render.index(name)
</code></pre><p>（'index' 是模板的名字，'name' 是传入模板的一个参数）
</p>
<p>访问站点它将显示 hello Bob。
</p>
<p>但是如果我们想让用户自行输入他的名字，么办？如下：
</p>
<pre><code>i = web.input(name=None)
return render.index(i.name)
</code></pre><p>访问 <code>/</code> 将显示 hello world，访问 <code>/?name=Joe</code> 将显示 hello Joe。
</p>
<p>URL 的后面的 <code>?</code> 看起来不好看？修改下 URL 配置：
</p>
<pre><code>'/(.*)', 'index'
</code></pre><p>然后修改下 <code>index.GET</code>：
</p>
<pre><code>def GET(self, name):
    return render.index(name)
</code></pre><p>现在访问 <code>/Joe</code> 看看，它会显示 hello Joe。
</p>
<p>如果学习更多关于 web.py 的模板处理，请访问 <a href="/docs/0.3/templetor" class="internal">web.py 模板</a>.
</p>

<h2>数据库操作</h2>
<p><strong>注意:</strong> 在你开始使用数据库之前，确保你已经安装了合适的数据库访问库。比如对于MySQL数据库，使用 <a href="http://sourceforge.net/project/showfiles.php?group_id=22307">MySQLdb</a> ，对于Postgres数据库使用<a href="http://initd.org/pub/software/psycopg/">psycopg2</a>。
</p>
<p>首先你需要创建一个数据库对象。
</p>
<pre><code>db = web.database(dbn='postgres', user='username', pw='password', db='dbname')
</code></pre><p>(根据需要修改这里 -- 尤其是<code>username</code> 、 <code>password</code> 、 <code>dbname</code> -- 。 MySQL用户还需要把 <code>dbn</code> 定义改为 <code>mysql</code>。)
</p>
<p>这就是所有你需要做的 -- web.py将会自动处理与数据库的连接和断开。
</p>
<p>使用的的数据库引擎管理工具，在你的库中创建一个简单的表:
</p>
<pre><code>CREATE TABLE todo (
  id serial primary key,
  title text,
  created timestamp default now(),
  done boolean default 'f'    );
</code></pre><p>然后初始化行:
</p>
<pre><code>INSERT INTO todo (title) VALUES ('Learn web.py');
</code></pre><p>我们回来继续编辑 <code>code.py</code> ，把 <code>index.GET</code> 改成下面的样子，替换整个函数:
</p>
<pre><code>def GET(self):
    todos = db.select('todo')
    return render.index(todos)
</code></pre><p>然后把URL列表改回来，只保留 <code>/</code>:
</p>
<pre><code>'/', 'index',
</code></pre><p>像这样编辑并替换 <code>index.html</code> 的全部内容:
</p>
<pre><code>$def with (todos)
&lt;ul&gt;
$for todo in todos:
    &lt;li id=&quot;t$todo.id&quot;&gt;$todo.title&lt;/li&gt;
&lt;/ul&gt;
</code></pre><p>再访问你的网站，然后你可以看到你的todo item: &quot;Learn web.py&quot;。恭喜你！你已经完整地写好了一个可以从数据库读取数据的程序。现在让我们同样再写一个可以把数据写入数据库的程序。
</p>
<p>在 <code>index.html</code>尾部添加:
</p>
<pre><code>&lt;form method=&quot;post&quot; action=&quot;add&quot;&gt;
&lt;p&gt;&lt;input type=&quot;text&quot; name=&quot;title&quot; /&gt; &lt;input type=&quot;submit&quot; value=&quot;Add&quot; /&gt;&lt;/p&gt;
&lt;/form&gt;
</code></pre><p>然后把你的URL列表改为:
</p>
<pre><code>'/', 'index',
'/add', 'add'
</code></pre><p>(你必须要非常小心那些逗号。如果你省略他们，Python会把所有字符串连接起来,变成 <code>'/index/addadd'</code>)
</p>
<p>现在添加另一个类:
</p>
<pre><code>class add:
    def POST(self):
        i = web.input()
        n = db.insert('todo', title=i.title)
        raise web.seeother('/')
</code></pre><p>(注意现在我们正在使用 <code>POST</code>)
</p>
<p><code>web.input</code> 可以让你访问用户通过form提交的任何数据。
</p>
<p>注意: 如果要访问多个相同名字的字段，请使用list的格式(比如:一串name=&quot;name&quot;的多选框):
</p>
<pre><code>post_data=web.input(name=[])
</code></pre><p><code>db.insert</code> 把数据插入数据表 <code>todo</code> ，然后把新的行号返回给你。 <code>seeother</code> 把用户重定向到指定的URL。
</p>
<p>一些快速补充说明: <code>db.update</code> 与 <code>db.insert</code> 差不多，除了它返回的行号是直接从sql语句里面提取的(<code>WHERE ID=2</code>)。
</p>
<p><code>web.input</code>、 <code>db.query</code>已经其他web.py中的函数返回&quot;Storage objects&quot;，这些东西就像字典，你除了可以 <code>d['foo']</code>之外，你还可以 <code>d.foo</code>。这可以让代码更加干净。
</p>
<p>你可以在<a href="/docs/0.3">the documentation</a>找到这方面具体的细节以及所有web.py的函数说明。
</p>

<h2>开发</h2>
<p>web.py 还有一些帮助我们debug的工具。当它在内建的服务器中运行时，它会一debug模式启动程序。在debug模式中，任何代码、模板的修改，都会让服务器重新加载它们，然后还会输出有用的错误消息。
</p>
<p>只有在生产环境中debug模式是关闭的。如果你想禁用debug模式，你可以在创建程序/模板前添加像这样的行。
</p>
<pre><code>web.config.debug = False
</code></pre><p>我们的指南就到这里了。如果要做更多很酷的东西，你可以先查看一下文档。
</p>

<h2>下一步是什么?</h2>
<ul>
 <li>
     <a href="/docs/0.3" class="internal">更多文档</a>
 </li>

 <li>
     <a href="/cookbook" class="internal">Cookbook</a>
 </li>

 <li>
     <a href="/src" class="internal">code samples</a>
 </li>
</ul>




<div style="clear: both;"></div>

</div>

</div>

        <div id="footer">
    <p>started by <a style="color: gray;" href="http://www.aaronsw.com/">Aaron Swartz</a> (<a style="color: black;" href="mailto:webpy@aaronsw.com">webpy@aaronsw.com</a>)</p>
</div>

</body>
</html>
